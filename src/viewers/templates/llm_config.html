{% extends "base.html" %}

{% block title %}LLM Configuration - Image Analysis{% endblock %}

{% block extra_css %}
<style>
.prompt-preview {
    font-family: 'Courier New', monospace;
    background-color: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    display: inline-block;
    max-width: 100%;
    word-wrap: break-word;
}

.model-card {
    border-left: 4px solid #007bff;
}

.model-card.ollama {
    border-left-color: #28a745;
}

.model-card.openai {
    border-left-color: #17a2b8;
}

.model-card.anthropic {
    border-left-color: #6f42c1;
}

.model-card.google {
    border-left-color: #fd7e14;
}

.model-card.grok {
    border-left-color: #e83e8c;
}

.model-card.cohere {
    border-left-color: #20c997;
}

.model-card.mistral {
    border-left-color: #6c757d;
}

.model-card.perplexity {
    border-left-color: #ffc107;
}

.prompt-textarea {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.4;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-robot"></i> LLM Configuration</h1>
                <div>
                    <span class="badge bg-primary">{{ configured_models|length }} Configured</span>
                    <span class="badge bg-success">{{ available_models|length }} Available</span>
                </div>
            </div>

            <!-- Connection Status -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-server me-2"></i>
                                Ollama Server
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if ollama_connected %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span class="text-success">Connected</span>
                                </div>
                                <small class="text-muted">Server is running and accessible</small>
                            {% else %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                    <span class="text-danger">Not Connected</span>
                                </div>
                                <small class="text-muted">Make sure Ollama is running on localhost:11434</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-key me-2"></i>
                                OpenAI API
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if openai_connected %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span class="text-success">Connected</span>
                                </div>
                                <small class="text-muted">API key is valid</small>
                            {% else %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                    <span class="text-danger">Not Connected</span>
                                </div>
                                <small class="text-muted">Set OPENAI_API_KEY in your .env file</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-brain me-2"></i>
                                Anthropic API
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if anthropic_connected %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span class="text-success">Connected</span>
                                </div>
                                <small class="text-muted">API key is valid</small>
                            {% else %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                    <span class="text-danger">Not Connected</span>
                                </div>
                                <small class="text-muted">Set ANTHROPIC_API_KEY in your .env file</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-search me-2"></i>
                                Google API
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if google_connected %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span class="text-success">Connected</span>
                                </div>
                                <small class="text-muted">API key is valid</small>
                            {% else %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                    <span class="text-danger">Not Connected</span>
                                </div>
                                <small class="text-muted">Set GOOGLE_API_KEY in your .env file</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-rocket me-2"></i>
                                Grok API (xAI)
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if grok_connected %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span class="text-success">Connected</span>
                                </div>
                                <small class="text-muted">API key is valid</small>
                            {% else %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                    <span class="text-danger">Not Connected</span>
                                </div>
                                <small class="text-muted">Set GROK_API_KEY in your .env file</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cube me-2"></i>
                                Cohere API
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if cohere_connected %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span class="text-success">Connected</span>
                                </div>
                                <small class="text-muted">API key is valid</small>
                            {% else %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                    <span class="text-danger">Not Connected</span>
                                </div>
                                <small class="text-muted">Set COHERE_API_KEY in your .env file</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-wind me-2"></i>
                                Mistral API
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if mistral_connected %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span class="text-success">Connected</span>
                                </div>
                                <small class="text-muted">API key is valid</small>
                            {% else %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                    <span class="text-danger">Not Connected</span>
                                </div>
                                <small class="text-muted">Set MISTRAL_API_KEY in your .env file</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-question-circle me-2"></i>
                                Perplexity API
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if perplexity_connected %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <span class="text-success">Connected</span>
                                </div>
                                <small class="text-muted">API key is valid</small>
                            {% else %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                    <span class="text-danger">Not Connected</span>
                                </div>
                                <small class="text-muted">Set PERPLEXITY_API_KEY in your .env file</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Available Models -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                Available Models
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if available_models %}
                                <div class="row">
                                    {% for model in available_models %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card border">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="card-title mb-1">{{ model.name }}</h6>
                                                        <span class="badge bg-{{ 
                                                            'primary' if model.type == 'ollama' 
                                                            else 'success' if model.type == 'openai'
                                                            else 'purple' if model.type == 'anthropic'
                                                            else 'warning' if model.type == 'google'
                                                            else 'danger' if model.type == 'grok'
                                                            else 'info' if model.type == 'cohere'
                                                            else 'secondary' if model.type == 'mistral'
                                                            else 'warning' if model.type == 'perplexity'
                                                            else 'primary'
                                                        }} mb-2">
                                                            {{ model.type|upper }}
                                                        </span>
                                                        {% if model.type == 'ollama' and model.size %}
                                                            <br><small class="text-muted">Size: {{ model.size }}</small>
                                                        {% endif %}
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-primary" 
                                                            onclick="addModel('{{ model.name }}', '{{ model.type }}', '{{ model.url }}', '{{ model.model_name }}')">
                                                        <i class="fas fa-plus"></i> Add
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-exclamation-triangle fa-2x text-muted mb-3"></i>
                                    <p class="text-muted">No models available</p>
                                    <p class="small text-muted">
                                        Make sure Ollama is running or configure your OpenAI API key
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Configured Models -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cog me-2"></i>
                                Configured Models
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if configured_models %}
                                {% for model in configured_models %}
                                <div class="card border mb-3 model-card {{ model.type }}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h6 class="card-title mb-1">{{ model.name }}</h6>
                                                <span class="badge bg-{{ 
                                                    'primary' if model.type == 'ollama' 
                                                    else 'success' if model.type == 'openai'
                                                    else 'purple' if model.type == 'anthropic'
                                                    else 'warning' if model.type == 'google'
                                                    else 'danger' if model.type == 'grok'
                                                    else 'info' if model.type == 'cohere'
                                                    else 'secondary' if model.type == 'mistral'
                                                    else 'warning' if model.type == 'perplexity'
                                                    else 'primary'
                                                }}">
                                                    {{ model.type|upper }}
                                                </span>
                                            </div>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary" 
                                                        onclick="editPrompts({{ model.id }}, '{{ model.name }}', '{{ model.prompts or '' }}')"
                                                        title="Edit Prompts">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        onclick="deleteModel({{ model.id }})"
                                                        title="Delete Model">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        {% if model.prompts %}
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <strong>Prompts:</strong><br>
                                                    <span class="prompt-preview">{{ model.prompts[:100] }}{{ '...' if model.prompts|length > 100 else '' }}</span>
                                                </small>
                                            </div>
                                        {% else %}
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-exclamation-triangle"></i> No prompts configured
                                                </small>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-robot fa-2x text-muted mb-3"></i>
                                    <p class="text-muted">No models configured</p>
                                    <p class="small text-muted">
                                        Add models from the available list to start using them
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Model Modal -->
<div class="modal fade" id="addModelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add LLM Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addModelForm">
                    <div class="mb-3">
                        <label for="modelName" class="form-label">Model Name</label>
                        <input type="text" class="form-control" id="modelName" required>
                    </div>
                    <div class="mb-3">
                        <label for="modelType" class="form-label">Type</label>
                        <select class="form-select" id="modelType" required>
                            <option value="ollama">Ollama</option>
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google</option>
                            <option value="grok">Grok (xAI)</option>
                            <option value="cohere">Cohere</option>
                            <option value="mistral">Mistral</option>
                            <option value="perplexity">Perplexity</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="modelUrl" class="form-label">URL</label>
                        <input type="text" class="form-control" id="modelUrl">
                        <div class="form-text">Leave empty for default URLs</div>
                    </div>
                    <div class="mb-3" id="apiKeyGroup" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>API Key:</strong> Uses environment variable <code id="apiKeyEnvVar"></code>
                            <br><small class="text-muted">Set this in your .env file or system environment variables</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="internalModelName" class="form-label">Internal Model Name</label>
                        <input type="text" class="form-control" id="internalModelName" required>
                        <div class="form-text">The model identifier used by the API</div>
                    </div>
                    <div class="mb-3">
                        <label for="modelPrompts" class="form-label">Prompts</label>
                        <textarea class="form-control prompt-textarea" id="modelPrompts" rows="4" placeholder="Enter prompts for this model..."></textarea>
                        <div class="form-text">Prompts that will be used for image analysis with this model</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveModel()">Add Model</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Prompts Modal -->
<div class="modal fade" id="editPromptsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Prompts - <span id="editModelName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="editPrompts" class="form-label">Prompts</label>
                    <textarea class="form-control prompt-textarea" id="editPrompts" rows="8" placeholder="Enter prompts for this model..."></textarea>
                    <div class="form-text">Prompts that will be used for image analysis with this model</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePrompts()">Save Prompts</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentModelData = {};
let currentEditingModelId = null;

function addModel(name, type, url, modelName) {
    currentModelData = { name, type, url, modelName };
    
    document.getElementById('modelName').value = name;
    document.getElementById('modelType').value = type;
    document.getElementById('modelUrl').value = url || '';
    document.getElementById('internalModelName').value = modelName;
    document.getElementById('modelPrompts').value = '';
    
    // Show/hide API key field based on type
    const apiKeyGroup = document.getElementById('apiKeyGroup');
    const apiKeyEnvVar = document.getElementById('apiKeyEnvVar');
    
    const apiKeyMap = {
        'openai': 'OPENAI_API_KEY',
        'anthropic': 'ANTHROPIC_API_KEY',
        'google': 'GOOGLE_API_KEY',
        'grok': 'GROK_API_KEY',
        'cohere': 'COHERE_API_KEY',
        'mistral': 'MISTRAL_API_KEY',
        'perplexity': 'PERPLEXITY_API_KEY'
    };
    
    if (apiKeyMap[type]) {
        apiKeyGroup.style.display = 'block';
        apiKeyEnvVar.textContent = apiKeyMap[type];
    } else {
        apiKeyGroup.style.display = 'none';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('addModelModal'));
    modal.show();
}

function saveModel() {
    const formData = {
        name: document.getElementById('modelName').value,
        type: document.getElementById('modelType').value,
        url: document.getElementById('modelUrl').value || null,
        api_key: null, // API keys are handled by environment variables
        model_name: document.getElementById('internalModelName').value,
        prompts: document.getElementById('modelPrompts').value || null
    };
    
    fetch('/api/llm/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Close modal and reload page
            const modal = bootstrap.Modal.getInstance(document.getElementById('addModelModal'));
            modal.hide();
            location.reload();
        } else {
            throw new Error(data.error || 'Failed to add model');
        }
    })
    .catch(error => {
        alert('Error adding model: ' + error.message);
    });
}

function editPrompts(modelId, modelName, currentPrompts) {
    currentEditingModelId = modelId;
    document.getElementById('editModelName').textContent = modelName;
    document.getElementById('editPrompts').value = currentPrompts;
    
    const modal = new bootstrap.Modal(document.getElementById('editPromptsModal'));
    modal.show();
}

function savePrompts() {
    if (!currentEditingModelId) return;
    
    const prompts = document.getElementById('editPrompts').value;
    
    fetch(`/api/llm/update-prompts/${currentEditingModelId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ prompts: prompts })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Close modal and reload page
            const modal = bootstrap.Modal.getInstance(document.getElementById('editPromptsModal'));
            modal.hide();
            location.reload();
        } else {
            throw new Error(data.error || 'Failed to update prompts');
        }
    })
    .catch(error => {
        alert('Error updating prompts: ' + error.message);
    });
}

function deleteModel(modelId) {
    if (confirm('Are you sure you want to delete this model configuration?')) {
        fetch(`/api/llm/delete/${modelId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                throw new Error(data.error || 'Failed to delete model');
            }
        })
        .catch(error => {
            alert('Error deleting model: ' + error.message);
        });
    }
}

// Handle model type change
document.getElementById('modelType').addEventListener('change', function() {
    const apiKeyGroup = document.getElementById('apiKeyGroup');
    const apiKeyEnvVar = document.getElementById('apiKeyEnvVar');
    
    const apiKeyMap = {
        'openai': 'OPENAI_API_KEY',
        'anthropic': 'ANTHROPIC_API_KEY',
        'google': 'GOOGLE_API_KEY',
        'grok': 'GROK_API_KEY',
        'cohere': 'COHERE_API_KEY',
        'mistral': 'MISTRAL_API_KEY',
        'perplexity': 'PERPLEXITY_API_KEY'
    };
    
    if (apiKeyMap[this.value]) {
        apiKeyGroup.style.display = 'block';
        apiKeyEnvVar.textContent = apiKeyMap[this.value];
    } else {
        apiKeyGroup.style.display = 'none';
    }
});
</script>
{% endblock %} 