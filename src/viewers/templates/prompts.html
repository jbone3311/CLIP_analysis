{% extends "base.html" %}

{% block title %}Prompt Management - Image Analysis{% endblock %}

{% block extra_css %}
<style>
.prompt-card {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.prompt-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.prompt-card.comprehensive { border-left-color: #007bff; }
.prompt-card.detection { border-left-color: #28a745; }
.prompt-card.color { border-left-color: #fd7e14; }
.prompt-card.artistic { border-left-color: #6f42c1; }
.prompt-card.generation { border-left-color: #e83e8c; }
.prompt-card.technical { border-left-color: #20c997; }
.prompt-card.psychological { border-left-color: #ffc107; }
.prompt-card.database { border-left-color: #6c757d; }

.prompt-textarea {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.4;
    min-height: 200px;
}

.prompt-preview {
    font-family: 'Courier New', monospace;
    background-color: #f8f9fa;
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.category-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.prompt-stats {
    font-size: 0.875rem;
    color: #6c757d;
}

.modal-xl {
    max-width: 90%;
}

.prompt-form-group {
    margin-bottom: 1.5rem;
}

.prompt-form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.prompt-form-group .form-control {
    border-radius: 0.375rem;
}

.prompt-form-group .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.btn-prompt-action {
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.prompt-actions {
    position: absolute;
    top: 1rem;
    right: 1rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.prompt-card:hover .prompt-actions {
    opacity: 1;
}

.prompt-header {
    position: relative;
    padding-right: 120px;
}

.prompt-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
}

.prompt-meta-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
    color: #6c757d;
}

.prompt-meta-item i {
    width: 16px;
}

.prompt-content {
    margin-top: 1rem;
    max-height: 150px;
    overflow: hidden;
    position: relative;
}

.prompt-content::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(transparent, white);
    pointer-events: none;
}

.prompt-content.expanded {
    max-height: none;
}

.prompt-content.expanded::after {
    display: none;
}

.expand-toggle {
    position: absolute;
    bottom: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    cursor: pointer;
    z-index: 1;
}

.expand-toggle:hover {
    background: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-edit"></i> Prompt Management</h1>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPromptModal">
                        <i class="fas fa-plus"></i> Add New Prompt
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportPrompts()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-outline-secondary" onclick="importPrompts()">
                        <i class="fas fa-upload"></i> Import
                    </button>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="promptSearch" placeholder="Search prompts...">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-2">
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="comprehensive">Comprehensive</option>
                            <option value="detection">Detection</option>
                            <option value="color">Color</option>
                            <option value="artistic">Artistic</option>
                            <option value="generation">Generation</option>
                            <option value="technical">Technical</option>
                            <option value="psychological">Psychological</option>
                            <option value="database">Database</option>
                        </select>
                        <button class="btn btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Prompts Grid -->
            <div class="row" id="promptsGrid">
                {% for prompt_id, prompt in prompts.items() %}
                <div class="col-lg-6 col-xl-4 mb-4 prompt-item" data-category="{{ prompt.CATEGORY }}" data-title="{{ prompt.TITLE.lower() }}">
                    <div class="card prompt-card {{ prompt.CATEGORY }}">
                        <div class="card-body">
                            <div class="prompt-header">
                                <h5 class="card-title mb-1">{{ prompt.TITLE }}</h5>
                                <span class="badge category-badge bg-secondary">{{ prompt.CATEGORY|title }}</span>
                                
                                <div class="prompt-actions">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editPrompt('{{ prompt_id }}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deletePrompt('{{ prompt_id }}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="prompt-meta">
                                <div class="prompt-meta-item">
                                    <i class="fas fa-thermometer-half"></i>
                                    <span>Temp: {{ prompt.TEMPERATURE }}</span>
                                </div>
                                <div class="prompt-meta-item">
                                    <i class="fas fa-hashtag"></i>
                                    <span>Tokens: {{ prompt.MAX_TOKENS }}</span>
                                </div>
                                <div class="prompt-meta-item">
                                    <i class="fas fa-id-card"></i>
                                    <span>ID: {{ prompt_id }}</span>
                                </div>
                            </div>

                            <div class="prompt-content" id="content-{{ prompt_id }}">
                                <div class="prompt-preview">{{ prompt.PROMPT_TEXT[:300] }}{% if prompt.PROMPT_TEXT|length > 300 %}...{% endif %}</div>
                                {% if prompt.PROMPT_TEXT|length > 300 %}
                                <div class="expand-toggle" onclick="toggleExpand('{{ prompt_id }}')">
                                    Show More
                                </div>
                                {% endif %}
                            </div>

                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary" onclick="previewPrompt('{{ prompt_id }}')">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="testPrompt('{{ prompt_id }}')">
                                    <i class="fas fa-play"></i> Test
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="duplicatePrompt('{{ prompt_id }}')">
                                    <i class="fas fa-copy"></i> Duplicate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Empty State -->
            <div class="text-center py-5" id="emptyState" style="display: none;">
                <i class="fas fa-edit fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No prompts found</h4>
                <p class="text-muted">Create your first prompt to get started.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPromptModal">
                    <i class="fas fa-plus"></i> Add New Prompt
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Prompt Modal -->
<div class="modal fade" id="promptModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="promptModalTitle">Add New Prompt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="promptForm">
                    <input type="hidden" id="promptId" name="promptId">
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="prompt-form-group">
                                <label for="promptTitle">Title</label>
                                <input type="text" class="form-control" id="promptTitle" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="prompt-form-group">
                                <label for="promptCategory">Category</label>
                                <select class="form-control" id="promptCategory" name="category" required>
                                    <option value="comprehensive">Comprehensive</option>
                                    <option value="detection">Detection</option>
                                    <option value="color">Color</option>
                                    <option value="artistic">Artistic</option>
                                    <option value="generation">Generation</option>
                                    <option value="technical">Technical</option>
                                    <option value="psychological">Psychological</option>
                                    <option value="database">Database</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="prompt-form-group">
                                <label for="promptTemperature">Temperature</label>
                                <input type="range" class="form-range" id="promptTemperature" name="temperature" min="0" max="1" step="0.1" value="0.7">
                                <div class="d-flex justify-content-between">
                                    <small>0.0 (Focused)</small>
                                    <small id="tempValue">0.7</small>
                                    <small>1.0 (Creative)</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="prompt-form-group">
                                <label for="promptMaxTokens">Max Tokens</label>
                                <input type="number" class="form-control" id="promptMaxTokens" name="maxTokens" min="100" max="8000" value="2000">
                            </div>
                        </div>
                    </div>

                    <div class="prompt-form-group">
                        <label for="promptText">Prompt Text</label>
                        <textarea class="form-control prompt-textarea" id="promptText" name="text" rows="15" required></textarea>
                        <div class="form-text">
                            <span id="charCount">0</span> characters | 
                            <span id="wordCount">0</span> words | 
                            <span id="lineCount">0</span> lines
                        </div>
                    </div>

                    <div class="prompt-form-group">
                        <label>Preview</label>
                        <div class="prompt-preview" id="promptPreview"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePrompt()">Save Prompt</button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prompt Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- Test Prompt Modal -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Prompt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Upload Test Image</h6>
                        <input type="file" class="form-control" id="testImage" accept="image/*">
                        <div class="mt-3">
                            <img id="testImagePreview" class="img-fluid" style="max-height: 300px; display: none;">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Prompt Details</h6>
                        <div id="testPromptDetails"></div>
                    </div>
                </div>
                <div class="mt-4">
                    <button class="btn btn-primary" onclick="runTest()">
                        <i class="fas fa-play"></i> Run Test
                    </button>
                </div>
                <div class="mt-3">
                    <h6>Test Results</h6>
                    <div id="testResults" class="prompt-preview"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let prompts = {{ prompts|tojson }};
let isEditing = false;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    updateCounts();
});

function setupEventListeners() {
    // Search functionality
    document.getElementById('promptSearch').addEventListener('input', filterPrompts);
    document.getElementById('categoryFilter').addEventListener('change', filterPrompts);
    
    // Form controls
    document.getElementById('promptTemperature').addEventListener('input', function() {
        document.getElementById('tempValue').textContent = this.value;
    });
    
    document.getElementById('promptText').addEventListener('input', function() {
        updateCounts();
        updatePreview();
    });
    
    document.getElementById('promptTitle').addEventListener('input', updatePreview);
    document.getElementById('promptCategory').addEventListener('change', updatePreview);
}

function updateCounts() {
    const text = document.getElementById('promptText').value;
    document.getElementById('charCount').textContent = text.length;
    document.getElementById('wordCount').textContent = text.split(/\s+/).filter(word => word.length > 0).length;
    document.getElementById('lineCount').textContent = text.split('\n').length;
}

function updatePreview() {
    const title = document.getElementById('promptTitle').value;
    const category = document.getElementById('promptCategory').value;
    const text = document.getElementById('promptText').value;
    
    const preview = `Title: ${title}\nCategory: ${category}\n\n${text}`;
    document.getElementById('promptPreview').textContent = preview;
}

function filterPrompts() {
    const searchTerm = document.getElementById('promptSearch').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    const promptItems = document.querySelectorAll('.prompt-item');
    let visibleCount = 0;
    
    promptItems.forEach(item => {
        const title = item.dataset.title;
        const category = item.dataset.category;
        const matchesSearch = title.includes(searchTerm);
        const matchesCategory = !categoryFilter || category === categoryFilter;
        
        if (matchesSearch && matchesCategory) {
            item.style.display = 'block';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    document.getElementById('emptyState').style.display = visibleCount === 0 ? 'block' : 'none';
}

function resetFilters() {
    document.getElementById('promptSearch').value = '';
    document.getElementById('categoryFilter').value = '';
    filterPrompts();
}

function editPrompt(promptId) {
    const prompt = prompts[promptId];
    if (!prompt) return;
    
    isEditing = true;
    document.getElementById('promptModalTitle').textContent = 'Edit Prompt';
    document.getElementById('promptId').value = promptId;
    document.getElementById('promptTitle').value = prompt.TITLE;
    document.getElementById('promptCategory').value = prompt.CATEGORY;
    document.getElementById('promptTemperature').value = prompt.TEMPERATURE;
    document.getElementById('tempValue').textContent = prompt.TEMPERATURE;
    document.getElementById('promptMaxTokens').value = prompt.MAX_TOKENS;
    document.getElementById('promptText').value = prompt.PROMPT_TEXT;
    
    updateCounts();
    updatePreview();
    
    new bootstrap.Modal(document.getElementById('promptModal')).show();
}

function addNewPrompt() {
    isEditing = false;
    document.getElementById('promptModalTitle').textContent = 'Add New Prompt';
    document.getElementById('promptForm').reset();
    document.getElementById('promptId').value = '';
    document.getElementById('tempValue').textContent = '0.7';
    
    updateCounts();
    updatePreview();
}

function savePrompt() {
    const formData = new FormData(document.getElementById('promptForm'));
    const promptData = {
        TITLE: formData.get('title'),
        CATEGORY: formData.get('category'),
        TEMPERATURE: parseFloat(formData.get('temperature')),
        MAX_TOKENS: parseInt(formData.get('maxTokens')),
        PROMPT_TEXT: formData.get('text')
    };
    
    const promptId = formData.get('promptId') || generatePromptId(promptData.TITLE);
    
    // Save to server
    fetch('/api/prompts', {
        method: isEditing ? 'PUT' : 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            promptId: promptId,
            prompt: promptData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            prompts[promptId] = promptData;
            location.reload(); // Refresh to show changes
        } else {
            alert('Error saving prompt: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving prompt');
    });
}

function deletePrompt(promptId) {
    if (!confirm('Are you sure you want to delete this prompt?')) return;
    
    fetch(`/api/prompts/${promptId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            delete prompts[promptId];
            location.reload();
        } else {
            alert('Error deleting prompt: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting prompt');
    });
}

function previewPrompt(promptId) {
    const prompt = prompts[promptId];
    if (!prompt) return;
    
    const content = `Title: ${prompt.TITLE}\nCategory: ${prompt.CATEGORY}\nTemperature: ${prompt.TEMPERATURE}\nMax Tokens: ${prompt.MAX_TOKENS}\n\n${prompt.PROMPT_TEXT}`;
    document.getElementById('previewContent').textContent = content;
    
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function testPrompt(promptId) {
    const prompt = prompts[promptId];
    if (!prompt) return;
    
    document.getElementById('testPromptDetails').innerHTML = `
        <strong>Title:</strong> ${prompt.TITLE}<br>
        <strong>Category:</strong> ${prompt.CATEGORY}<br>
        <strong>Temperature:</strong> ${prompt.TEMPERATURE}<br>
        <strong>Max Tokens:</strong> ${prompt.MAX_TOKENS}
    `;
    
    new bootstrap.Modal(document.getElementById('testModal')).show();
}

function runTest() {
    const fileInput = document.getElementById('testImage');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select an image to test with');
        return;
    }
    
    // Show loading state
    document.getElementById('testResults').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Running test...</div>';
    
    // Here you would implement the actual test logic
    // For now, we'll simulate a response
    setTimeout(() => {
        document.getElementById('testResults').innerHTML = `
            <strong>Test completed successfully!</strong><br>
            <small class="text-muted">This is a simulated response. Implement actual LLM testing here.</small>
        `;
    }, 2000);
}

function duplicatePrompt(promptId) {
    const prompt = prompts[promptId];
    if (!prompt) return;
    
    const newId = promptId + '_copy';
    const newPrompt = {
        ...prompt,
        TITLE: prompt.TITLE + ' (Copy)'
    };
    
    prompts[newId] = newPrompt;
    
    // Save to server
    fetch('/api/prompts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            promptId: newId,
            prompt: newPrompt
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error duplicating prompt: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error duplicating prompt');
    });
}

function generatePromptId(title) {
    return title.toLowerCase()
        .replace(/[^a-z0-9]/g, '_')
        .replace(/_+/g, '_')
        .replace(/^_|_$/g, '');
}

function toggleExpand(promptId) {
    const content = document.getElementById(`content-${promptId}`);
    const toggle = content.querySelector('.expand-toggle');
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        toggle.textContent = 'Show More';
    } else {
        content.classList.add('expanded');
        toggle.textContent = 'Show Less';
    }
}

function exportPrompts() {
    const dataStr = JSON.stringify(prompts, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'prompts.json';
    link.click();
    URL.revokeObjectURL(url);
}

function importPrompts() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedPrompts = JSON.parse(e.target.result);
                
                fetch('/api/prompts/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(importedPrompts)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error importing prompts: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error importing prompts');
                });
            } catch (error) {
                alert('Invalid JSON file');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

// Handle file input preview
document.getElementById('testImage').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('testImagePreview');
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

// Handle modal events
document.getElementById('promptModal').addEventListener('show.bs.modal', function(e) {
    if (!isEditing) {
        addNewPrompt();
    }
});
</script>
{% endblock %} 