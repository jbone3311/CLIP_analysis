{% extends "base.html" %}

{% block title %}Analysis Results - Image Analysis{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-3">
            <i class="fas fa-chart-bar me-2"></i>
            Analysis Results
        </h1>
        <p class="text-muted">View and explore all your image analysis results.</p>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="searchInput" class="form-label">Search Images</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by image name...">
                    </div>
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="complete">Complete</option>
                            <option value="processing">Processing</option>
                            <option value="error">Error</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="analysisFilter" class="form-label">Analysis Type</label>
                        <select class="form-select" id="analysisFilter">
                            <option value="">All Types</option>
                            <option value="clip">CLIP Only</option>
                            <option value="llm">LLM Only</option>
                            <option value="metadata">Metadata Only</option>
                            <option value="all">All Analyses</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times me-2"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Analysis Results
                </h5>
                <div>
                    <span class="badge bg-primary" id="resultCount">{{ analyses|length }} results</span>
                </div>
            </div>
            <div class="card-body">
                {% if analyses %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Status</th>
                                    <th>Analyses</th>
                                    <th>Processing Time</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for analysis in analyses %}
                                <tr class="result-row" 
                                    data-filename="{{ analysis.original_image|lower }}"
                                    data-status="{{ analysis.status }}"
                                    data-analyses="{% if analysis.has_clip %}clip{% endif %}{% if analysis.has_llm %}llm{% endif %}{% if analysis.has_metadata %}metadata{% endif %}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                {% if analysis.thumbnail %}
                                                    <img src="{{ analysis.thumbnail }}" alt="{{ analysis.original_image }}" 
                                                         class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                                                {% else %}
                                                    <i class="fas fa-image fa-2x text-muted"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <strong>{{ analysis.original_image }}</strong>
                                                <div class="text-muted small">{{ analysis.filename }}</div>
                                                <div class="text-muted small">{{ "{:,}".format(analysis.file_size) }} bytes</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="status-badge status-{{ analysis.status }}">
                                            {{ analysis.status.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            {% if analysis.has_clip %}
                                                <span class="badge bg-info">CLIP</span>
                                            {% endif %}
                                            {% if analysis.has_llm %}
                                                <span class="badge bg-success">LLM</span>
                                            {% endif %}
                                            {% if analysis.has_metadata %}
                                                <span class="badge bg-secondary">Metadata</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ "%.2f"|format(analysis.processing_time) }}s</strong>
                                    </td>
                                    <td>
                                        {{ analysis.date_processed[:10] if analysis.date_processed else 'N/A' }}
                                        <div class="text-muted small">{{ analysis.date_processed[11:19] if analysis.date_processed else '' }}</div>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('view_result', filename=analysis.filename) }}" 
                                               class="btn btn-sm btn-outline-primary" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('download_result', filename=analysis.filename) }}" 
                                               class="btn btn-sm btn-outline-success" title="Download">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-info" 
                                                    onclick="showQuickPreview('{{ analysis.filename }}')" title="Quick Preview">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No analysis results found</h4>
                        <p class="text-muted">Start by uploading images and processing them to see results here.</p>
                        <div class="mt-3">
                            <a href="{{ url_for('upload') }}" class="btn btn-primary me-2">
                                <i class="fas fa-upload me-2"></i>
                                Upload Images
                            </a>
                            <a href="{{ url_for('process') }}" class="btn btn-success">
                                <i class="fas fa-cogs me-2"></i>
                                Process Images
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Preview Modal -->
<div class="modal fade" id="quickPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>
                    Quick Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="quickPreviewContent">
                <div class="text-center">
                    <div class="loading-spinner"></div>
                    <p class="mt-2">Loading preview...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="viewFullBtn">
                    <i class="fas fa-external-link-alt me-2"></i>
                    View Full Details
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const analysisFilter = document.getElementById('analysisFilter');
    const resultRows = document.querySelectorAll('.result-row');
    const resultCount = document.getElementById('resultCount');
    
    // Search and filter functionality
    function filterResults() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const analysisValue = analysisFilter.value;
        
        let visibleCount = 0;
        
        resultRows.forEach(row => {
            const filename = row.dataset.filename;
            const status = row.dataset.status;
            const analyses = row.dataset.analyses;
            
            let show = true;
            
            // Search filter
            if (searchTerm && !filename.includes(searchTerm)) {
                show = false;
            }
            
            // Status filter
            if (statusValue && status !== statusValue) {
                show = false;
            }
            
            // Analysis filter
            if (analysisValue) {
                if (analysisValue === 'clip' && !analyses.includes('clip')) show = false;
                if (analysisValue === 'llm' && !analyses.includes('llm')) show = false;
                if (analysisValue === 'metadata' && !analyses.includes('metadata')) show = false;
                if (analysisValue === 'all' && !(analyses.includes('clip') && analyses.includes('llm') && analyses.includes('metadata'))) show = false;
            }
            
            row.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        });
        
        resultCount.textContent = `${visibleCount} results`;
    }
    
    // Event listeners
    searchInput.addEventListener('input', filterResults);
    statusFilter.addEventListener('change', filterResults);
    analysisFilter.addEventListener('change', filterResults);
    
    // Clear filters
    window.clearFilters = function() {
        searchInput.value = '';
        statusFilter.value = '';
        analysisFilter.value = '';
        filterResults();
    };
});

// Quick preview functionality
function showQuickPreview(filename) {
    const modal = new bootstrap.Modal(document.getElementById('quickPreviewModal'));
    const content = document.getElementById('quickPreviewContent');
    const viewFullBtn = document.getElementById('viewFullBtn');
    
    // Set the view full button link
    viewFullBtn.href = `/result/${filename}`;
    
    // Show loading
    content.innerHTML = `
        <div class="text-center">
            <div class="loading-spinner"></div>
            <p class="mt-2">Loading preview...</p>
        </div>
    `;
    
    modal.show();
    
    // Fetch analysis data
    fetch(`/api/analysis/${filename}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading preview: ${data.error}
                    </div>
                `;
                return;
            }
            
            // Display preview
            let previewHtml = '<div class="row">';
            
            // File info
            previewHtml += `
                <div class="col-12 mb-3">
                    <h6><i class="fas fa-file-image me-2"></i>File Information</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Name:</strong> ${data.file_info?.filename || 'Unknown'}<br>
                            <strong>Size:</strong> ${(data.file_info?.file_size || 0).toLocaleString()} bytes<br>
                            <strong>Status:</strong> <span class="status-badge status-${data.processing_info?.status || 'unknown'}">${(data.processing_info?.status || 'unknown').toUpperCase()}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Processing Time:</strong> ${(data.processing_info?.processing_time || 0).toFixed(2)}s<br>
                            <strong>Date Processed:</strong> ${data.file_info?.date_processed || 'N/A'}
                        </div>
                    </div>
                </div>
            `;
            
            // LLM Analysis preview
            if (data.analysis?.llm && data.analysis.llm.length > 0) {
                previewHtml += `
                    <div class="col-12 mb-3">
                        <h6><i class="fas fa-robot me-2"></i>LLM Analysis</h6>
                        <div class="border rounded p-3 bg-light">
                `;
                
                data.analysis.llm.forEach((response, index) => {
                    if (response.status === 'success' && response.result?.choices?.[0]?.message?.content) {
                        const content = response.result.choices[0].message.content;
                        previewHtml += `
                            <div class="mb-2">
                                <strong>Prompt ${index + 1}:</strong><br>
                                <small class="text-muted">${content.substring(0, 200)}${content.length > 200 ? '...' : ''}</small>
                            </div>
                        `;
                    }
                });
                
                previewHtml += '</div></div>';
            }
            
            // Metadata preview
            if (data.analysis?.metadata) {
                const metadata = data.analysis.metadata;
                previewHtml += `
                    <div class="col-12 mb-3">
                        <h6><i class="fas fa-info-circle me-2"></i>Metadata</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Dimensions:</strong> ${metadata.width || 'N/A'} x ${metadata.height || 'N/A'}<br>
                                <strong>Format:</strong> ${metadata.format || 'N/A'}<br>
                                <strong>Color Mode:</strong> ${metadata.color_mode || 'N/A'}
                            </div>
                            <div class="col-md-6">
                                <strong>Aspect Ratio:</strong> ${metadata.aspect_ratio ? metadata.aspect_ratio.toFixed(2) : 'N/A'}<br>
                                <strong>DPI:</strong> ${metadata.dpi ? `${metadata.dpi[0]} x ${metadata.dpi[1]}` : 'N/A'}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            previewHtml += '</div>';
            content.innerHTML = previewHtml;
        })
        .catch(error => {
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading preview: ${error.message}
                </div>
            `;
        });
}
</script>
{% endblock %} 